name: Deploy to production environment

concurrency: production

on:
  push:
    branches:
      - dev

jobs:
  deployment:
    runs-on: self-hosted
    environment: production
    concurrency: production
    steps:
      - name: Run
        uses: actions/checkout@v2
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install
      - name: Build the project
        run: bun run build:prod
      - name: Build docker image
        run: docker build -t conflux-web .
      - name: Kill existing container
        run: docker stop conflux-web || true
      - name: Remove existing container
        run: docker rm conflux-web || true
      - name: Run container
        run: docker run -d --env VIRTUAL_HOST=conflux.stokmans.dev --env LETSENCRYPT_HOST=conflux.stokmans.dev --name conflux-web conflux-web